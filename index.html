<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Film Premiere | Official Tickets</title>
    
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.7/dist/umd/supabase.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://unpkg.com/intasend-inlinejs-sdk@3.0.4/build/intasend-inline.js"></script>
    
    <link rel="stylesheet" href="./style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
</head>
<body>

<a href="https://wa.me/2547XXXXXXXX" class="help-float" target="_blank">Need Help?</a>

<div class="container">
    <div class="card">
        <div id="customerView">
            <header>
                <div style="width: 80px; height: 80px; margin: 0 auto 10px; border-radius: 50%; border: 3px solid var(--brand-teal); padding: 4px; background: white; display: flex; align-items: center; justify-content: center;">
                    <img src="logo.png" alt="Logo" style="width: 100%; height: 100%; border-radius: 50%; object-fit: contain;">
                </div>
                <div class="brand-name">MUTCU</div>
                <h1>Film Premiere</h1>
            </header>

            <div class="countdown-timer" id="timer">
                <div class="timer-unit"><span id="days">00</span><small>Days</small></div>
                <div class="timer-unit"><span id="hours">00</span><small>Hrs</small></div>
                <div class="timer-unit"><span id="minutes">00</span><small>Min</small></div>
                <div class="timer-unit"><span id="seconds">00</span><small>Sec</small></div>
            </div>

            <form id="ticketForm">
                <label>Full Name</label>
                <input type="text" id="name" placeholder="Enter your name" required>
                
                <label>Phone Number (M-Pesa)</label>
                <input type="tel" id="phone" placeholder="0712345678" required>
                
                <label>Ticket Category</label>
                <select id="type" onchange="updateFomoDisplay(); toggleGroupFields();">
                    <option value="Regular">Regular Ticket - 100/-</option>
                    <option value="VIP">VIP Ticket - 200/-</option>
                    <option value="Group of 5">Group of 5 - 400/-</option>
                </select>

                <div id="fomoBox" style="text-align: center; margin-top: 15px;">
                    <span id="availabilityMsg" style="font-size: 0.8rem; color: var(--text-dim);">Checking availability...</span>
                </div>

                <div id="groupFields" class="hidden">
                    <label>Group Member Names</label>
                    <input type="text" class="member-name" placeholder="Member 2" style="margin-bottom: 8px;">
                    <input type="text" class="member-name" placeholder="Member 3" style="margin-bottom: 8px;">
                    <input type="text" class="member-name" placeholder="Member 4" style="margin-bottom: 8px;">
                    <input type="text" class="member-name" placeholder="Member 5">
                </div>
                
                <button type="submit" id="submitBtn">Pay and Get Ticket</button>
                
                <p style="text-align:center; font-size:12px; margin-top:25px; cursor:pointer" onclick="showRetrievePrompt()">
                    Already paid? <span style="color:var(--brand-teal); font-weight: 700;">Retrieve ticket</span>
                </p>
            </form>

            <div id="statusArea" class="hidden"></div>
        </div>

        <div id="adminView" class="hidden">
             <button onclick="window.location.hash=''" style="background:#333; margin-top: 20px;">Exit Admin</button>
        </div>
    </div>
</div>

<script>
    // --- CONFIGURATION ---
    const SUPABASE_URL = "https://jvrxmnvetjftssflgela.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2cnhtbnZldGpmdHNzZmxnZWxhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0MjA5MzQsImV4cCI6MjA4Mjk5NjkzNH0.u0dufDHF9s7C4XhoVEQPqgBcjwdJtmjyC0f0J1yd310"; 
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    const INTASEND_KEY = "ISPubKey_test_620da1ea-5e59-4597-9308-02e9ec9a2f6d"; 
    const PRICES = { "Regular": 100, "VIP": 200, "Group of 5": 400 };
    const CAPACITY = { "Regular": 50, "VIP": 20, "Group of 5": 10 };

    window.addEventListener('DOMContentLoaded', () => {
        startCountdown();
        updateFomoDisplay();
    });

    // --- UPDATED PAYMENT LOGIC ---
    document.getElementById('ticketForm').onsubmit = async (e) => {
        e.preventDefault();
        
        const btn = document.getElementById('submitBtn');
        const name = document.getElementById('name').value;
        const phone = document.getElementById('phone').value;
        const type = document.getElementById('type').value;
        const amount = PRICES[type];

        let formattedPhone = phone.replace(/\D/g, ""); 
        if (formattedPhone.startsWith("0")) {
            formattedPhone = "254" + formattedPhone.substring(1);
        }

        btn.innerText = "Connecting...";
        btn.disabled = true;

        try {
            const intasend = new IntaSend({
                public_key: INTASEND_KEY,
                live: false 
            });

            // Switched to .checkout() for better browser compatibility
            intasend.checkout({
                amount: amount,
                currency: "KES",
                phone_number: formattedPhone,
                email: "guest@mutcu.com"
            })
            .on("COMPLETE", async (results) => {
                const mpesaCode = results.transaction_id || "TEST_MODE";
                
                let groupNames = "";
                document.querySelectorAll('.member-name').forEach(i => { if(i.value) groupNames += i.value + ", "; });

                const { data, error } = await _supabase.from('tickets').insert([{
                    name: name,
                    phone: formattedPhone,
                    ticket_type: type,
                    mpesa_code: mpesaCode,
                    group_members: groupNames,
                    status: 'approved' 
                }]).select();

                if (error) {
                    alert("Database Error: " + error.message);
                } else {
                    document.getElementById('ticketForm').classList.add('hidden');
                    document.getElementById('statusArea').classList.remove('hidden');
                    renderTicket(data[0]);
                }
            })
            .on("FAILED", (results) => {
                alert("Payment window closed or failed.");
                btn.disabled = false;
                btn.innerText = "Pay and Get Ticket";
            })
            .on("IN-PROGRESS", () => {
                btn.innerText = "Waiting for M-Pesa...";
            });

        } catch (err) {
            console.error("Intasend setup error:", err);
            alert("Could not start payment. Check your internet connection or ad-blocker.");
            btn.disabled = false;
            btn.innerText = "Pay and Get Ticket";
        }
    };

    function renderTicket(data) {
        const statusArea = document.getElementById('statusArea');
        statusArea.innerHTML = `
            <h3 id="statusMsg" style="text-align: center; color: var(--brand-teal); font-weight: 800; margin-bottom:15px;">âœ… TICKET VERIFIED!</h3>
            <div id="printableTicket" style="background:white; padding:20px; border-radius:15px; text-align:center; color:#000;">
                <div style="background:var(--brand-navy); color:white; padding:5px 15px; border-radius:50px; display:inline-block; font-size:12px; margin-bottom:10px;">${data.ticket_type}</div>
                <h2 style="margin: 10px 0; font-size:1.2rem;">OFFICIAL ENTRANCE PASS</h2>
                <div id="qrcode" style="display:flex; justify-content:center; margin:15px 0;"></div>
                <div style="border-top:1px dashed #ccc; padding-top:15px;">
                    <div style="font-weight:900; font-size:1.1rem;">${data.name}</div>
                    <div style="font-size:11px; color:#666; margin-top:5px;">REF: ${data.mpesa_code}</div>
                    <div style="font-size:10px; color:var(--brand-pink); font-weight:bold; margin-top:2px;">ID: ${data.id}</div>
                </div>
            </div>
            <button onclick="downloadTicket()" style="background: var(--brand-navy); color: white; margin-top: 20px; width:100%; border-radius:10px; padding:15px; border:none; cursor:pointer;">ðŸ’¾ Save to Gallery</button>
        `;
        
        new QRCode(document.getElementById("qrcode"), { 
            text: `ID:${data.id}`, width: 160, height: 160, colorDark : "#04162e", colorLight : "#ffffff"
        });
    }

    async function showRetrievePrompt() {
        const code = prompt("Enter your M-Pesa Transaction Code:");
        if (!code) return;
        
        const { data, error } = await _supabase.from('tickets')
            .select('*')
            .eq('mpesa_code', code.toUpperCase().trim())
            .single();

        if (data) {
            document.getElementById('ticketForm').classList.add('hidden');
            document.getElementById('statusArea').classList.remove('hidden');
            renderTicket(data);
        } else {
            alert("No ticket found with that code.");
        }
    }

    async function downloadTicket() {
        const canvas = await html2canvas(document.getElementById('printableTicket'), { scale: 3 });
        const link = document.createElement('a');
        link.download = `MUTCU_Ticket.png`;
        link.href = canvas.toDataURL();
        link.click();
    }

    async function updateFomoDisplay() {
        try {
            const type = document.getElementById('type').value;
            const { count } = await _supabase.from('tickets')
                .select('*', { count: 'exact', head: true })
                .eq('ticket_type', type);
            
            const remaining = CAPACITY[type] - (count || 0);
            document.getElementById('availabilityMsg').innerText = remaining > 0 ? `${remaining} tickets left` : "SOLD OUT";
        } catch (e) {
            console.log("Fomo display error", e);
        }
    }

    function toggleGroupFields() {
        const isGroup = document.getElementById('type').value === 'Group of 5';
        document.getElementById('groupFields').classList.toggle('hidden', !isGroup);
    }

    function startCountdown() {
        const premiereDate = new Date("2026-02-15T18:00:00").getTime();
        setInterval(() => {
            const distance = premiereDate - new Date().getTime();
            if (distance < 0) return;
            document.getElementById("days").innerText = Math.floor(distance / (1000 * 60 * 60 * 24)).toString().padStart(2, '0');
            document.getElementById("hours").innerText = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)).toString().padStart(2, '0');
            document.getElementById("minutes").innerText = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60)).toString().padStart(2, '0');
            document.getElementById("seconds").innerText = Math.floor((distance % (1000 * 60)) / 1000).toString().padStart(2, '0');
        }, 1000);
    }
</script>

</body>
</html>