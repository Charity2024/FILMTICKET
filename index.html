<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Film Premiere | Official Tickets</title>
    
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.7/dist/umd/supabase.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    
    <link rel="stylesheet" href="./style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
</head>
<body>

<div class="container">
    <div class="card">
        <div id="customerView">
            <header>
                <h1>Film Premiere</h1>
                <p>Join us for <thead></thead> exclusive cinematic experience!</p>
            </header>

            <div class="payment-info">
                <strong>Lipa na M-Pesa</strong><br>
                Paybill: <b>123456</b> | Acc: <b>Movie</b><br>
                <span>100/- (Reg) | 200/- (VIP) | 400/- (Group)</span>
            </div>

            <form id="ticketForm">
                <label for="name">Full Name</label>
                <input type="text" id="name" placeholder="Enter your official name" required>
                
                <label for="phone">Phone Number</label>
                <input type="tel" id="phone" placeholder="0712..." required>
                
                <label for="type">Ticket Category</label>
                <select id="type">
                    <option value="Regular">Regular Admission â€” 100/-</option>
                    <option value="VIP">VIP Access â€” 200/-</option>
                    <option value="Group of 5">Group of 5 â€” 400/-</option>
                </select>

                <label for="code">M-Pesa Transaction Code</label>
                <input type="text" id="code" placeholder="e.g. SAK8..." required>
                
                <button type="submit" id="submitBtn">Get My Ticket</button>
            </form>

            <div id="statusArea" class="hidden">
                <h3 id="statusMsg" style="text-align: center; margin-bottom: 20px;">Processing Payment...</h3>
                
                <div id="printableTicket">
                    <div id="displayType">Category</div>
                    <h2 style="margin: 10px 0; letter-spacing: 1px; font-size: 1.2em;">OFFICIAL ENTRANCE PASS</h2>
                    
                    <div id="qrcode"></div>
                    
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #f0f0f0;">
                        <div id="displayName" style="font-weight: 700; font-size: 1.1em;">Guest Name</div>
                        <div style="font-size: 0.7em; color: #999; margin-top: 5px;">TICKET ID: <span id="displayId">---</span></div>
                    </div>
                </div>
                
                <button id="downloadBtn" class="hidden" onclick="downloadTicket()" style="background: var(--teal); margin-top: 20px;">ðŸ’¾ Save Ticket to Gallery</button>
            </div>
        </div>

        <div id="adminView" class="hidden">
            <header>
                <h1>Admin Panel</h1>
                <p>Manage check-ins and approvals.</p>
            </header>
            
            <div id="scannerSection" class="hidden">
                <div id="reader"></div>
                <button onclick="stopScanner()" style="background:#e74c3c; margin-top: 10px;">Close Scanner</button>
            </div>

            <button id="scanBtn" onclick="startScanner()" style="background: var(--navy);">ðŸ“· Scan QR Code</button>
            
            <div style="margin-top: 30px;">
                <label>Pending Approvals</label>
                <div id="pendingList">Loading...</div>
            </div>
            
            <button class="admin-btn" onclick="window.location.hash=''">Exit Admin Mode</button>
        </div>
    </div>
</div>

<script>
   // Config
    const SUPABASE_URL = "https://wpdtbiedtkjmsiarpchk.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndwZHRiaWVkdGtqbXNpYXJwY2hrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0MDA1NTMsImV4cCI6MjA4Mjk3NjU1M30.bbOsMvs-TJYd7Lh4f7xlwEqz6UwMJK4ktTGVD4hO764";
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const ADMIN_PASSWORD = "1234"; // Change this to your preferred PIN

    // Navigation Logic with Password Protection
    async function route() {
        const isAdmin = window.location.hash === '#admin';
        const customerView = document.getElementById('customerView');
        const adminView = document.getElementById('adminView');

        if (isAdmin) {
            const password = prompt("Enter Admin PIN to access dashboard:");
            if (password === ADMIN_PASSWORD) {
                customerView.classList.add('hidden');
                adminView.classList.remove('hidden');
                loadPendingTickets();
            } else {
                alert("Incorrect PIN.");
                window.location.hash = ''; // Boot them back to the home page
            }
        } else {
            customerView.classList.remove('hidden');
            adminView.classList.add('hidden');
        }
    }

    // Listen for hash changes and initial load
    window.addEventListener('hashchange', route);
    window.addEventListener('DOMContentLoaded', route);

    // --- CUSTOMER LOGIC ---

    document.getElementById('ticketForm').onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        btn.innerText = "Verifying...";
        btn.disabled = true;

        const { data, error } = await _supabase.from('tickets').insert([{
            name: document.getElementById('name').value,
            phone: document.getElementById('phone').value,
            ticket_type: document.getElementById('type').value,
            mpesa_code: document.getElementById('code').value.toUpperCase(),
            status: 'pending'
        }]).select();

        if (error) {
            alert("This M-Pesa code has already been used!");
            btn.innerText = "Get My Ticket";
            btn.disabled = false;
        } else {
            document.getElementById('ticketForm').classList.add('hidden');
            document.getElementById('statusArea').classList.remove('hidden');
            startPolling(data[0].mpesa_code);
        }
    };

    function startPolling(code) {
        const interval = setInterval(async () => {
            const { data } = await _supabase.from('tickets').select('*').eq('mpesa_code', code).single();
            if (data && data.status === 'approved') {
                clearInterval(interval);
                document.getElementById('statusMsg').innerHTML = "âœ… Verified!<br>Scan this at the entrance.";
                document.getElementById('displayName').innerText = data.name;
                document.getElementById('displayType').innerText = data.ticket_type;
                document.getElementById('displayId').innerText = data.id;

                document.getElementById("qrcode").innerHTML = ""; 
                new QRCode(document.getElementById("qrcode"), {
                    text: `ID:${data.id}`,
                    width: 180, height: 180,
                    colorDark : "#0d1b3e",
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.H
                });
                document.getElementById('downloadBtn').classList.remove('hidden');
            }
        }, 3000);
    }

    async function downloadTicket() {
        const ticket = document.getElementById('printableTicket');
        const canvas = await html2canvas(ticket, { scale: 3, backgroundColor: "#ffffff" });
        const link = document.createElement('a');
        link.download = `Ticket_${document.getElementById('displayName').innerText}.png`;
        link.href = canvas.toDataURL();
        link.click();
    }

    // --- ADMIN LOGIC ---

    async function loadPendingTickets() {
        const list = document.getElementById('pendingList');
        const { data } = await _supabase.from('tickets').select('*').eq('status', 'pending');
        list.innerHTML = data?.length ? "" : "<p style='color:#999;'>No pending tickets.</p>";
        data?.forEach(t => {
            const div = document.createElement('div');
            div.className = "admin-item";
            div.innerHTML = `
                <div>
                    <strong>${t.name}</strong><br>
                    <small>${t.mpesa_code} | ${t.ticket_type}</small>
                </div>
                <button onclick="approve(${t.id})" style="padding: 8px 15px; width: auto;">Approve</button>`;
            list.appendChild(div);
        });
    }

    async function approve(id) {
        await _supabase.from('tickets').update({ status: 'approved' }).eq('id', id);
        loadPendingTickets();
    }

    let scanner;
    function startScanner() {
        document.getElementById('scannerSection').classList.remove('hidden');
        scanner = new Html5Qrcode("reader");
        scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, async (txt) => {
            const id = txt.split(':')[1];
            stopScanner();
            const { data } = await _supabase.from('tickets').select('*').eq('id', id).single();
            if (!data) alert("âŒ Invalid Ticket");
            else if (data.checked_in) alert("âš ï¸ ALREADY USED by " + data.name);
            else {
                await _supabase.from('tickets').update({ checked_in: true }).eq('id', id);
                alert("âœ… WELCOME: " + data.name);
            }
        });
    }

    function stopScanner() {
        if (scanner) scanner.stop().then(() => document.getElementById('scannerSection').classList.add('hidden'));
    }
</script>
</body>
</html>